[tools]
erlang = "28"
elixir = "1.19-otp-28"
node = "22"

[env]
_.file = ".env"

[tasks.dev]
description = "Start Phoenix with cloudflare tunnel for sprite callbacks"
run = """
#!/usr/bin/env bash
LOG=$(mktemp)
cloudflared tunnel --url http://localhost:4000 > "$LOG" 2>&1 &
PID=$!
trap "kill $PID 2>/dev/null; rm -f $LOG" EXIT

for i in {1..20}; do
  URL=$(grep -o 'https://[a-z0-9-]*\\.trycloudflare\\.com' "$LOG" 2>/dev/null | head -1)
  if [ -n "$URL" ]; then
    echo "Tunnel: $URL"
    SPRITE_CALLBACK_URL="$URL" exec mix phx.server
  fi
  sleep 0.5
done
echo "Tunnel failed to start"; cat "$LOG"; exit 1
"""
